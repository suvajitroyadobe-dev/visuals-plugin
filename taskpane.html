<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>SR Visuals</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        .btn { width: 100%; padding: 10px; background: #d83b01; color: white; border: none; margin-top: 10px; cursor: pointer; }
        textarea { width: 100%; height: 60px; }
        /* ডিবাগ লগ এরিয়া */
        #debugLog { background: #eee; padding: 5px; margin-top: 10px; font-size: 11px; color: red; border: 1px solid #ccc; min-height: 50px; }
    </style>
</head>
<body>
    <h3>SR Visuals Debug Mode</h3>
    
    <label>API Key:</label>
    <input type="password" id="userApiKey" style="width: 100%;" placeholder="Paste HF Token...">
    
    <label style="margin-top: 10px; display: block;">Icon Description:</label>
    <textarea id="iconInput">cat</textarea>
    
    <button id="btnGenerate" class="btn">Generate Icon</button>
    
    <div id="svgContainer" style="border: 1px dashed black; margin-top: 10px; min-height: 100px; text-align: center;">Preview Area</div>
    <div id="debugLog">Logs will appear here...</div>

    <script>
        // স্ক্রিনে লগ দেখানোর ফাংশন
        function log(msg) {
            var d = document.getElementById("debugLog");
            d.innerHTML += ">> " + msg + "<br>";
            console.log(msg);
        }

        Office.onReady(function(info) {
            log("Office Ready! Host: " + info.host);
            
            document.getElementById("btnGenerate").onclick = function() {
                var prompt = document.getElementById("iconInput").value;
                var apiKey = document.getElementById("userApiKey").value;
                
                log("1. Button Clicked. Sending request...");
                
                // ফেচ রিকোয়েস্ট
                fetch("https://suvajit01-sr-visuals-backend.hf.space/generate-icon", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        prompt: prompt,
                        style: "napkin",
                        api_type: "huggingface",
                        user_key: apiKey
                    })
                })
                .then(function(response) {
                    log("2. Server Responded: " + response.status);
                    return response.json();
                })
                .then(function(data) {
                    log("3. Data Received.");
                    
                    if (data.svg) {
                        document.getElementById("svgContainer").innerHTML = data.svg;
                        log("4. Preview Updated.");
                    }

                    if (data.raw_image) {
                        log("5. Found Image Data. Inserting...");
                        insertImage(data.raw_image);
                    } else {
                        log("ERROR: 'raw_image' missing in response! Check main.py");
                    }
                })
                .catch(function(err) {
                    log("Network Error: " + err.message);
                });
            };
        });

        function insertImage(base64) {
            Office.context.document.setSelectedDataAsync(
                base64,
                { coercionType: Office.CoercionType.Image },
                function(result) {
                    if (result.status === Office.AsyncResultStatus.Failed) {
                        log("Insert Failed: " + result.error.message);
                    } else {
                        log("SUCCESS! Icon Inserted.");
                    }
                }
            );
        }
    </script>
</body>
</html>
